<title>Viewer</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<style>
.dot {
	position:absolute;
	width:30px;
	height:30px;
	background-color:gray;
	border-radius:15px;
	text-align:center;
	font:bold 20px "Open Sans";
	color:white;
	line-height:28px;
	z-index: 3
}
textarea {
	width:100%; height:20%; display:none;
}
canvas {
	position:absolute;
	top:0; left:0;
	z-index: 1
}
#log {
	position:absolute;
	right:20px;
	top:0;
	font: normal 14pt 'Open Sans';
	max-width: 300px
}
</style>
<div style="position:relative;" id="regions">
</div>
<textarea style="font-family:monaco;" id="output"></textarea>
<div style="font-size:large" id="attacker"></div>
<div style="font-size:large" id="defender"></div>
<div id="log"></div>
<button id="load">load</button>
<script>
$(function() {
	$("#output").val(JSON.stringify(game));
	render(game);
});
var map = {"src":"uk.jpg","regions":[{"id":0,"x":417,"y":294,"neighbours":[41,40,1,2,3]},{"id":1,"x":571,"y":322,"neighbours":[0,3,2]},{"id":2,"x":539,"y":417,"neighbours":[0,1]},{"id":3,"x":443,"y":431,"neighbours":[0,1,4]},{"id":4,"x":505,"y":556,"neighbours":[3,5,6,7]},{"id":5,"x":462,"y":632,"neighbours":[4,15,30,7]},{"id":6,"x":570,"y":542,"neighbours":[4,7]},{"id":7,"x":568,"y":653,"neighbours":[4,5,6,8,9,30]},{"id":8,"x":661,"y":713,"neighbours":[7,9,32]},{"id":9,"x":597,"y":747,"neighbours":[7,8,31]},{"id":10,"x":309,"y":653,"neighbours":[15,11]},{"id":11,"x":262,"y":675,"neighbours":[14,13,12,10]},{"id":12,"x":201,"y":655,"neighbours":[18,16,11]},{"id":13,"x":237,"y":715,"neighbours":[16,14,11]},{"id":14,"x":291,"y":728,"neighbours":[17,16,15,11,13]},{"id":15,"x":338,"y":728,"neighbours":[5,14,10]},{"id":16,"x":246,"y":772,"neighbours":[18,17,12,13,14]},{"id":17,"x":260,"y":815,"neighbours":[19,20,18,16,14]},{"id":18,"x":148,"y":811,"neighbours":[20,21,17,16,12]},{"id":19,"x":308,"y":853,"neighbours":[29,20,17,30]},{"id":20,"x":258,"y":913,"neighbours":[19,22,18,17]},{"id":21,"x":135,"y":905,"neighbours":[22,18,23]},{"id":22,"x":207,"y":953,"neighbours":[20,23,21]},{"id":23,"x":147,"y":994,"neighbours":[39,22,24,21]},{"id":24,"x":77,"y":1016,"neighbours":[23]},{"id":25,"x":421,"y":1028,"neighbours":[26]},{"id":26,"x":476,"y":1012,"neighbours":[27,25,37,28]},{"id":27,"x":518,"y":968,"neighbours":[36,33,37,26,28]},{"id":28,"x":480,"y":901,"neighbours":[27,29,26]},{"id":29,"x":448,"y":863,"neighbours":[28,19,30]},{"id":30,"x":437,"y":743,"neighbours":[5,7,31,29,19]},{"id":31,"x":606,"y":825,"neighbours":[32,33,9,30]},{"id":32,"x":709,"y":856,"neighbours":[8,31,33,34]},{"id":33,"x":670,"y":972,"neighbours":[32,34,35,36,31,27]},{"id":34,"x":809,"y":975,"neighbours":[32,35,33]},{"id":35,"x":739,"y":1060,"neighbours":[34,38,36,33]},{"id":36,"x":601,"y":1015,"neighbours":[35,38,27,33]},{"id":37,"x":517,"y":1057,"neighbours":[27,26]},{"id":38,"x":626,"y":1117,"neighbours":[35,36,39]},{"id":39,"x":474,"y":1167,"neighbours":[38,23]},{"id":40,"x":278,"y":233,"neighbours":[0]},{"id":41,"x":538,"y":98,"neighbours":[42,0]},{"id":42,"x":764,"y":125,"neighbours":[41]}]};

var selected = null;
var divs = [];

/*
var game = {
	map: map,
	players: [
		{id:0, name:"MegaBot"},
		{id:1, name:"JakobBot"},
		{id:2, name:"JesperBot"},
		{id:3, name:"BotenAnna"},		
	],
	occupants: {
		"0": {player: 0, strength: 4},
		"1": {player: 1, strength: 3},
		"2": {player: 1, strength: 5},
	},
	moves: [
		{type: "attack", player:0, attackerRoll: [6, 6, 2, 2], defenderRoll: [5, 2, 1], from: 0, to: 1},
		{type: "end_turn", player:0, reinforcements: [
			{region:0, strength: 1},
			{region:1, strength: 1},
		]},
		{type: "attack", player:1, attackerRoll: [6,6,5,5,1], defenderRoll: [2, 2], from: 2, to: 0},
		{type: "attack", player:1, attackerRoll: [6,2,2,1], defenderRoll: [5, 2, 2, 1], from: 0, to: 1},
		{type: "end_turn", player:1, reinforcements: [
			{region:0, strength: 1},
			{region:1, strength: 1},
			{region:2, strength: 1},
		]},
	]
}*/
var bla = {"map":{"src":null,"regions":[{"id":0,"x":0,"y":0,"name":"a0","neighbours":[3,1]},{"id":1,"x":0,"y":50,"name":"a1","neighbours":[4,0,2]},{"id":2,"x":0,"y":100,"name":"a2","neighbours":[5,1]},{"id":3,"x":50,"y":0,"name":"b0","neighbours":[0,6,4]},{"id":4,"x":50,"y":50,"name":"b1","neighbours":[1,7,3,5]},{"id":5,"x":50,"y":100,"name":"b2","neighbours":[2,8,4]},{"id":6,"x":100,"y":0,"name":"c0","neighbours":[3,7]},{"id":7,"x":100,"y":50,"name":"c1","neighbours":[4,6,8]},{"id":8,"x":100,"y":100,"name":"c2","neighbours":[5,7]}]},"players":[{"id":0,"name":"p1","implementation":"SimpleBot","argument":null},{"id":1,"name":"p2","implementation":"SimpleBot","argument":null},{"id":2,"name":"p3","implementation":"SimpleBot","argument":null},{"id":3,"name":"p4","implementation":"SimpleBot","argument":null},{"id":4,"name":"p5","implementation":"SimpleBot","argument":null}],"occupants":{"0":{"player":0,"strength":8},"1":{"player":4,"strength":1},"2":{"player":1,"strength":8},"3":{"player":0,"strength":0},"4":{"player":0,"strength":0},"5":{"player":0,"strength":0},"6":{"player":2,"strength":8},"7":{"player":4,"strength":1},"8":{"player":3,"strength":8}},"moves":[],"currentPlayer":0,"currentTurn":0,"maxTurns":100}

var game = {"map":{"regions":[{"id":0,"x":200,"y":200,"name":"a0","neighbours":[3,1]},{"id":1,"x":200,"y":250,"name":"a1","neighbours":[4,0,2]},{"id":2,"x":200,"y":300,"name":"a2","neighbours":[5,1]},{"id":3,"x":250,"y":200,"name":"b0","neighbours":[0,6,4]},{"id":4,"x":250,"y":250,"name":"b1","neighbours":[1,7,3,5]},{"id":5,"x":250,"y":300,"name":"b2","neighbours":[2,8,4]},{"id":6,"x":300,"y":200,"name":"c0","neighbours":[3,7]},{"id":7,"x":300,"y":250,"name":"c1","neighbours":[4,6,8]},{"id":8,"x":300,"y":300,"name":"c2","neighbours":[5,7]}]},"players":[{"id":0,"name":"p1","implementation":"SimpleBot"},{"id":1,"name":"p2","implementation":"SimpleBot"},{"id":2,"name":"p3","implementation":"SimpleBot"},{"id":3,"name":"p4","implementation":"SimpleBot"},{"id":4,"name":"p5","implementation":"SimpleBot"}],"occupants":{"0":{"player":0,"strength":5},"1":{"player":0,"strength":1},"2":{"player":0,"strength":3},"3":{"player":0,"strength":3},"4":{"player":0,"strength":3},"5":{"player":0,"strength":1},"6":{"player":0,"strength":5},"7":{"player":0,"strength":5},"8":{"player":0,"strength":4}},"moves":[{"type":"MOVE","comment":"Attack","from":0,"to":1,"player":0,"attackerRoll":[1,5,2,6,6,6,6,4],"defenderRoll":[4]},{"type":"MOVE","comment":"Attack","from":1,"to":2,"player":0,"attackerRoll":[3,6,6,6,5,6,3],"defenderRoll":[5,4,6,3,2,1,3,6]},{"type":"DONE","comment":"Can't move","player":0,"reinforcements":[{"region":0,"strength":1},{"region":1,"strength":1},{"region":3,"strength":1},{"region":4,"strength":1},{"region":5,"strength":2}]},{"type":"DONE","comment":"Can't move","player":1,"reinforcements":[]},{"type":"MOVE","comment":"Attack","from":6,"to":3,"player":2,"attackerRoll":[6,6,6,6,3,3,4,6],"defenderRoll":[5]},{"type":"MOVE","comment":"Attack","from":3,"to":4,"player":2,"attackerRoll":[4,3,2,6,3,5,4],"defenderRoll":[5]},{"type":"MOVE","comment":"Attack","from":4,"to":7,"player":2,"attackerRoll":[5,5,1,2,4,3],"defenderRoll":[1]},{"type":"MOVE","comment":"Attack","from":7,"to":8,"player":2,"attackerRoll":[4,5,5,6,4],"defenderRoll":[2,6,5,2,1,1,4,2]},{"type":"MOVE","comment":"Attack","from":8,"to":5,"player":2,"attackerRoll":[3,5,1,3],"defenderRoll":[5,6]},{"type":"MOVE","comment":"Attack","from":5,"to":2,"player":2,"attackerRoll":[6,3,1],"defenderRoll":[6,1,2,5,2,4]},{"type":"DONE","comment":"Can't move","player":2,"reinforcements":[{"region":4,"strength":1},{"region":5,"strength":4},{"region":8,"strength":1}]},{"type":"DONE","comment":"Can't move","player":3,"reinforcements":[]},{"type":"DONE","comment":"Can't move","player":4,"reinforcements":[]},{"type":"MOVE","comment":"Attack","from":2,"to":5,"player":0,"attackerRoll":[4,2,4,5,1,1],"defenderRoll":[3,2,4,1,4]},{"type":"MOVE","comment":"Attack","from":5,"to":4,"player":0,"attackerRoll":[4,3,4,6,6],"defenderRoll":[4,2]},{"type":"MOVE","comment":"Attack","from":4,"to":3,"player":0,"attackerRoll":[4,4,1,2],"defenderRoll":[5]},{"type":"MOVE","comment":"Attack","from":3,"to":6,"player":0,"attackerRoll":[6,5,2],"defenderRoll":[2]},{"type":"MOVE","comment":"Attack","from":6,"to":7,"player":0,"attackerRoll":[2,1],"defenderRoll":[2]},{"type":"DONE","comment":"Can't move","player":0,"reinforcements":[{"region":0,"strength":1},{"region":1,"strength":2},{"region":2,"strength":2},{"region":3,"strength":1},{"region":6,"strength":2}]},{"type":"DONE","comment":"Can't move","player":1,"reinforcements":[]},{"type":"MOVE","comment":"Attack","from":8,"to":5,"player":2,"attackerRoll":[5,3],"defenderRoll":[5]},{"type":"DONE","comment":"Can't move","player":2,"reinforcements":[{"region":8,"strength":2}]},{"type":"DONE","comment":"Can't move","player":3,"reinforcements":[]},{"type":"DONE","comment":"Can't move","player":4,"reinforcements":[]},{"type":"MOVE","comment":"Attack","from":2,"to":5,"player":0,"attackerRoll":[6,4,6],"defenderRoll":[2]},{"type":"MOVE","comment":"Attack","from":5,"to":8,"player":0,"attackerRoll":[5,6],"defenderRoll":[3,5,4]},{"type":"DONE","comment":"Can't move","player":0,"reinforcements":[{"region":1,"strength":1},{"region":2,"strength":1},{"region":3,"strength":1},{"region":4,"strength":1},{"region":5,"strength":3},{"region":6,"strength":1}]},{"type":"DONE","comment":"Can't move","player":1,"reinforcements":[]},{"type":"MOVE","comment":"Attack","from":8,"to":7,"player":2,"attackerRoll":[6,6,5],"defenderRoll":[2]},{"type":"MOVE","comment":"Attack","from":7,"to":4,"player":2,"attackerRoll":[6,6],"defenderRoll":[3,1]},{"type":"DONE","comment":"Can't move","player":2,"reinforcements":[{"region":4,"strength":1},{"region":8,"strength":2}]},{"type":"DONE","comment":"Can't move","player":3,"reinforcements":[]},{"type":"DONE","comment":"Can't move","player":4,"reinforcements":[]},{"type":"MOVE","comment":"Attack","from":1,"to":4,"player":0,"attackerRoll":[4,6,4,1,6],"defenderRoll":[6,6]},{"type":"MOVE","comment":"Attack","from":4,"to":7,"player":0,"attackerRoll":[6,5,6,5],"defenderRoll":[1]},{"type":"MOVE","comment":"Attack","from":5,"to":8,"player":0,"attackerRoll":[5,3,4,2],"defenderRoll":[2,4,2]},{"type":"DONE","comment":"Can't move","player":0,"reinforcements":[{"region":0,"strength":2},{"region":2,"strength":1},{"region":4,"strength":2},{"region":6,"strength":1},{"region":7,"strength":2},{"region":8,"strength":1}]},{"type":"DONE","comment":"Can't move","player":1,"reinforcements":[]},{"type":"DONE","comment":"Can't move","player":2,"reinforcements":[]},{"type":"DONE","comment":"Can't move","player":3,"reinforcements":[]}],"currentPlayer":4,"currentTurn":3,"maxTurns":100}





;
game.occupants = bla.occupants;

var sounds = {
    fanfare:new Audio("sound/FanFare.mp3"),
    win_game:new Audio("sound/FanFareWin.mp3"),
    win_battle:new Audio("sound/SwordStab.mp3"),
    lose_battle:new Audio("sound/SwordClank.mp3"),
    reinforcement:new Audio("sound/bonk.mp3")
}



$("#load").click(function() {
	//render(JSON.parse($("#output").val()))
});
var colors = ["red", "blue", "green", "yellow", "purple"];
function render(game) {
	selected = null;
	divs = [];

	var el = $("#regions")
	el.empty();
	game.map.regions.forEach(function(r, i) {
		r.id = i;
		var div = createRegionDiv(r);
		divs.push(div);
		$("#regions").append(div);
	});
	var img = document.createElement("img");
	el.append(img);
	$(img).load(function() {
		el.append($('<canvas width="' + $(img).width() + '" height="' + $(img).height() + '"></canvas>'));
		$("canvas").click(function(e) {
			nextMove = 0;
			doMove();
		});
		drawNeighbourConnections();
	});
	img.src = map.src;

	game.map.regions.forEach(function(region) {
		if (game.occupants[region.id]) {
			divs[region.id].style.backgroundColor=colors[game.occupants[region.id].player];
			divs[region.id].innerText=game.occupants[region.id].strength;
		}
	});
}

var nextMove = 0;
function doMove() {
	var move = game.moves[nextMove++];
	console.log(move);
	if (move.type=="MOVE") {
		console.log("animating")
		var temp = createRegionDiv(game.map.regions[move.from]);
		temp.style.backgroundColor = colors[game.occupants[move.from].player];
		temp.innerText = game.occupants[move.from].strength;
		divs[move.from].innerText = "?";
		divs[move.to].innerText="?";
		divs[move.to].style.backgroundColor="black";
		$("#regions").append(temp);

		var attacker = game.players[game.occupants[move.from].player];
		var defender = game.players[game.occupants[move.to].player];
		var attackerSum = move.attackerRoll.reduce(function(a,b) {return a+b;});
		var defenderSum = move.defenderRoll.reduce(function(a,b) {return a+b;});

		$(temp).animate($(divs[move.to]).position(), 1000, function() {
			temp.remove();
			divs[move.from].style.backgroundColor=colors[game.occupants[move.from].player];
			divs[move.from].innerText=game.occupants[move.from].strength;
			divs[move.to].style.backgroundColor=colors[game.occupants[move.to].player];
			divs[move.to].innerText=game.occupants[move.to].strength;
			log(attacker.name + " attacks and rolls " + move.attackerRoll.join("+") + "="+attackerSum+", " + defender.name + " defends and rolls " + move.defenderRoll.join("+") + "=" + defenderSum);
            if (attackerSum > defenderSum) {
                sounds.win_battle.play();
            } else {
                sounds.lose_battle.play();
            }

		});
		if (attackerSum > defenderSum) {
			setStrengthAtRegion(move.to, game.occupants[move.from].strength - 1);
			game.occupants[move.to].player = game.occupants[move.from].player;
		}
		setStrengthAtRegion(move.from, 1);
		setTimeout(function() {
		}, 1000);
	} else if (move.type=="DONE") {
		var player = game.players[move.player];
		log(player.name + "'s turn ends.");
		var total = move.reinforcements.reduce(function(sum, reinforcement) {
			return sum + reinforcement.strength;
		}, 0);
		log(player.name + "'s turn ends: " + total + " reinforcements received.");
		var list = [];
		while (move.reinforcements.reduce(function(sum, reinforcement) {return sum + reinforcement.strength;}, 0)) {
			move.reinforcements.forEach(function(reinforcement) {
				if (reinforcement.strength) {
					reinforcement.strength--;
					list.push(reinforcement.region);
				}
			});
		}

		reinforce(move.player, list);
	}
	if (nextMove < game.moves.length) setTimeout(doMove, 2000);
}
function setStrengthAtRegion(regionId, strength){
	console.log(strength + " "+regionId );
	game.occupants[regionId].strength = strength;
	
	var dot = $(divs[regionId]);
	var size = (strength * 8);
//	dot.animate({width: (size + "px"), height: (size + "px")}, 500 );
	// dot.();

}


function reinforce(player, regions) {
	console.log("reinforce()", regions);
	var next = 0;
	var placeOne = function(regionId) {
		game.map.regions[regionId]
		var pos = $(divs[regionId]).position();
		var startCss = {
			width:100,
			height:100,
			"border-radius":50,
			"font-size": "95px",
			"line-height": "95px"
		}
		var endCss = $(divs[regionId]).css(["left","top","width","height","border-radius","font-size","line-height"]);
		var temp = createRegionDiv({id:0,x:pos.left,y:pos.top-300});
		$(temp).css({
			"background-color":colors[player],
			width:100,
			height:100,
			"border-radius":50,
			"font-size": "95px",
			"line-height": "95px"
		});
		temp.innerText = "1";
		$("#regions").append(temp);
		pos.width = 30;
		pos.height= 30;
		$(temp).animate(endCss, 500, function() {
			temp.remove();
			setStrengthAtRegion(regionId,game.occupants[regionId].strength + 1);
			divs[regionId].innerText=game.occupants[regionId].strength;
			if (next < regions.length) placeOne(regions[next++]);
            sounds.reinforcement.play();
		});
	}
	if (next < regions.length) placeOne(regions[next++]);
}

function createRegionDiv(region) {
	var div = document.createElement("div");
	div.className="dot";
	div.style.top=region.y-15;
	div.style.left=region.x-15;
	return div;
}

function log(message) {
	$("#log").append("<p>" + message + "</p>");
}

function drawNeighbourConnections() {
/*	var canvas = $("canvas").get(0);
	var ctx = canvas.getContext("2d");
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	ctx.beginPath();
	map.regions.forEach(function(r) {
		r.neighbours.forEach(function(nId) {
			var n = map.regions[nId];
			if (r.id < n.id) {
				ctx.moveTo(r.x,r.y);
				ctx.lineTo(n.x,n.y);
			}
		}); 
	});
	ctx.stroke();	*/
}
</script>